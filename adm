-- LocalScript in StarterPlayer > StarterPlayerScripts or StarterGui

local Players = game:GetService("Players")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

print("Script starting...")

-- Wait for TradeApp with error handling
local tradeApp = playerGui:WaitForChild("TradeApp", 10)
if not tradeApp then
	warn("TradeApp not found!")
	return
end
print("Found TradeApp")

local frame = tradeApp:WaitForChild("Frame", 10)
local negotiationFrame = frame:WaitForChild("NegotiationFrame", 10)
local header = negotiationFrame:WaitForChild("Header", 10)

-- Wait for DialogApp with error handling
local dialogApp = playerGui:WaitForChild("DialogApp", 10)
if not dialogApp then
	warn("DialogApp not found!")
end

local dialogTextLabel
if dialogApp then
	local dialog = dialogApp:WaitForChild("Dialog", 10)
	if dialog then
		local headerDialog = dialog:WaitForChild("HeaderDialog", 10)
		if headerDialog then
			local info = headerDialog:WaitForChild("Info", 10)
			if info then
				dialogTextLabel = info:WaitForChild("TextLabel", 10)
				print("Found DialogApp TextLabel")
			end
		end
	end
end

-- Get the partner name label
local partnerFrame = header:WaitForChild("PartnerFrame", 10)
local partnerNameLabel = partnerFrame:WaitForChild("NameLabel", 10)
print("Found PartnerFrame NameLabel")

-- Get the confirmation frame partner label
local confirmationFrame = frame:WaitForChild("ConfirmationFrame", 10)
local confirmPartnerLabel = confirmationFrame:WaitForChild("PartnerLabel", 10)
print("Found ConfirmationFrame PartnerLabel")

-- Store the desired partner name
local desiredPartnerName = ""

-- Configuration: Only change names if they match this username
-- Set this to the username you want to replace, or leave as "" to replace any name
local TARGET_USERNAME = "" -- Change this to the specific username you want to replace

print("TARGET_USERNAME is set to:", TARGET_USERNAME == "" and "(empty - will change any name)" or TARGET_USERNAME)

-- Store connection references so we can disconnect them
local connections = {}

-- Function to disconnect all auto-correct listeners
local function disconnectListeners()
	for _, connection in pairs(connections) do
		connection:Disconnect()
	end
	connections = {}
	print("Auto-correction listeners disconnected.")
end

-- Function to check if we should change the name
local function shouldChange(currentText)
	-- If no target is set, always change
	if TARGET_USERNAME == "" then
		return true
	end
	-- If target is set, only change if current text matches target
	return currentText == TARGET_USERNAME
end

-- Function to set the partner name
local function setPartnerName(name)
	desiredPartnerName = name
	print("==================")
	print("Setting partner name to:", name)
	print("Current partner label:", partnerNameLabel.Text)
	print("Current confirm label:", confirmPartnerLabel.Text)
	print("TARGET_USERNAME:", TARGET_USERNAME)
	print("==================")
	
	-- FORCE change partner name label (ignore target check for now)
	partnerNameLabel.Text = name
	print("✓ FORCED partner name to:", name)
	
	-- FORCE change confirmation label
	confirmPartnerLabel.Text = name
	print("✓ FORCED confirmation partner name to:", name)
	
	-- FORCE change dialog text if it exists
	if dialogTextLabel then
		dialogTextLabel.Text = name .. " sent you a trade request"
		print("✓ FORCED dialog text to:", name .. " sent you a trade request")
	end
	
	print("==================")
	print("After setting:")
	print("Partner label now:", partnerNameLabel.Text)
	print("Confirm label now:", confirmPartnerLabel.Text)
	if dialogTextLabel then
		print("Dialog text now:", dialogTextLabel.Text)
	end
	print("==================")
end

-- Function to setup auto-correct listeners
local function setupListeners()
	-- Clear any existing connections first
	disconnectListeners()
	
	-- Monitor partner name label changes
	table.insert(connections, partnerNameLabel:GetPropertyChangedSignal("Text"):Connect(function()
		if desiredPartnerName ~= "" and partnerNameLabel.Text ~= desiredPartnerName then
			if shouldChange(partnerNameLabel.Text) then
				partnerNameLabel.Text = desiredPartnerName
				print("Partner name auto-corrected to:", desiredPartnerName)
			end
		end
	end))

	-- Monitor confirmation partner label changes
	table.insert(connections, confirmPartnerLabel:GetPropertyChangedSignal("Text"):Connect(function()
		if desiredPartnerName ~= "" and confirmPartnerLabel.Text ~= desiredPartnerName then
			if shouldChange(confirmPartnerLabel.Text) then
				confirmPartnerLabel.Text = desiredPartnerName
				print("Confirmation partner name auto-corrected to:", desiredPartnerName)
			end
		end
	end))

	-- Monitor dialog text label changes
	if dialogTextLabel then
		table.insert(connections, dialogTextLabel:GetPropertyChangedSignal("Text"):Connect(function()
			if desiredPartnerName ~= "" then
				local expectedText = desiredPartnerName .. " sent you a trade request"
				local currentText = dialogTextLabel.Text
				
				if currentText ~= expectedText then
					-- Check if this looks like a trade request message
					if TARGET_USERNAME == "" or currentText:find(TARGET_USERNAME) or currentText:match("sent you a trade request") then
						dialogTextLabel.Text = expectedText
						print("Dialog text auto-corrected to:", expectedText)
					end
				end
			end
		end))
	end
	
	print("Auto-correction listeners enabled.")
end

-- Setup initial listeners
setupListeners()

-- Monitor when TradeApp.Frame becomes invisible and disconnect listeners
frame:GetPropertyChangedSignal("Visible"):Connect(function()
	if not frame.Visible then
		disconnectListeners()
		print("Trade window closed. Auto-correction disabled.")
	else
		setupListeners()
		print("Trade window opened. Auto-correction enabled.")
	end
end)

-- Create the moveable name picker GUI
local namePickerGui = Instance.new("ScreenGui")
namePickerGui.Name = "NamePickerGui"
namePickerGui.ResetOnSpawn = false
namePickerGui.Parent = playerGui

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 300, 0, 150)
mainFrame.Position = UDim2.new(0.5, -150, 0.5, -75)
mainFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
mainFrame.BorderSizePixel = 2
mainFrame.BorderColor3 = Color3.fromRGB(255, 255, 255)
mainFrame.Parent = namePickerGui

local uiCorner = Instance.new("UICorner")
uiCorner.CornerRadius = UDim.new(0, 8)
uiCorner.Parent = mainFrame

-- Title bar for dragging
local titleBar = Instance.new("Frame")
titleBar.Name = "TitleBar"
titleBar.Size = UDim2.new(1, 0, 0, 30)
titleBar.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 8)
titleCorner.Parent = titleBar

local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, 0, 1, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "Enter Partner Name"
titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextSize = 14
titleLabel.Parent = titleBar

-- Text input
local textBox = Instance.new("TextBox")
textBox.Name = "NameTextBox"
textBox.Size = UDim2.new(0.85, 0, 0, 35)
textBox.Position = UDim2.new(0.075, 0, 0.35, 0)
textBox.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
textBox.BorderSizePixel = 1
textBox.BorderColor3 = Color3.fromRGB(100, 100, 100)
textBox.Text = ""
textBox.PlaceholderText = "Enter name..."
textBox.TextColor3 = Color3.fromRGB(255, 255, 255)
textBox.Font = Enum.Font.Gotham
textBox.TextSize = 14
textBox.ClearTextOnFocus = false
textBox.Parent = mainFrame

local textBoxCorner = Instance.new("UICorner")
textBoxCorner.CornerRadius = UDim.new(0, 6)
textBoxCorner.Parent = textBox

-- Submit button
local submitButton = Instance.new("TextButton")
submitButton.Name = "SubmitButton"
submitButton.Size = UDim2.new(0.4, 0, 0, 35)
submitButton.Position = UDim2.new(0.3, 0, 0.7, 0)
submitButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
submitButton.BorderSizePixel = 0
submitButton.Text = "Set Name"
submitButton.TextColor3 = Color3.fromRGB(255, 255, 255)
submitButton.Font = Enum.Font.GothamBold
submitButton.TextSize = 14
submitButton.Parent = mainFrame

local buttonCorner = Instance.new("UICorner")
buttonCorner.CornerRadius = UDim.new(0, 6)
buttonCorner.Parent = submitButton

-- Make the GUI draggable
local dragging = false
local dragInput, mousePos, framePos

titleBar.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		mousePos = input.Position
		framePos = mainFrame.Position
		
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)

titleBar.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
		dragInput = input
	end
end)

game:GetService("UserInputService").InputChanged:Connect(function(input)
	if input == dragInput and dragging then
		local delta = input.Position - mousePos
		mainFrame.Position = UDim2.new(
			framePos.X.Scale,
			framePos.X.Offset + delta.X,
			framePos.Y.Scale,
			framePos.Y.Offset + delta.Y
		)
	end
end)

-- Submit button functionality
submitButton.MouseButton1Click:Connect(function()
	local partnerName = textBox.Text
	
	if partnerName ~= "" then
		setPartnerName(partnerName)
		
		-- Show a confirmation
		submitButton.Text = "✓ Set!"
		submitButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
		task.wait(0.5)
		submitButton.Text = "Set Name"
		submitButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
	end
end)

-- Allow Enter key to submit
textBox.FocusLost:Connect(function(enterPressed)
	if enterPressed and textBox.Text ~= "" then
		submitButton.MouseButton1Click:Fire()
	end
end)
