-- LocalScript in StarterPlayer > hryvhefhbcuhdec or StarterGui

local Players = game:GetService("Players")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Wait for TradeApp
local tradeApp = playerGui:WaitForChild("TradeApp")
local frame = tradeApp:WaitForChild("Frame")
local negotiationFrame = frame:WaitForChild("NegotiationFrame")
local header = negotiationFrame:WaitForChild("Header")

-- Wait for DialogApp
local dialogApp = playerGui:WaitForChild("DialogApp")
local dialog = dialogApp:WaitForChild("Dialog")
local headerDialog = dialog:WaitForChild("HeaderDialog")
local info = headerDialog:WaitForChild("Info")
local dialogTextLabel = info:WaitForChild("TextLabel")

-- Get the partner name label
local partnerFrame = header:WaitForChild("PartnerFrame")
local partnerNameLabel = partnerFrame:WaitForChild("NameLabel")

-- Get the confirmation frame partner label
local confirmationFrame = frame:WaitForChild("ConfirmationFrame")
local confirmPartnerLabel = confirmationFrame:WaitForChild("PartnerLabel")

-- Store the desired partner name
local desiredPartnerName = ""

-- Store the last actual partner name from the game
local lastPartnerName = ""

-- Store connection references so we can disconnect them
local connections = {}

-- Function to disconnect all auto-correct listeners
local function disconnectListeners()
	for _, connection in pairs(connections) do
		connection:Disconnect()
	end
	connections = {}
	print("Auto-correction listeners disconnected.")
end

-- Function to set the partner name
local function setPartnerName(name)
	desiredPartnerName = name
	partnerNameLabel.Text = name
	confirmPartnerLabel.Text = name
end

-- Function to setup auto-correct listeners
local function setupListeners()
	-- Clear any existing connections first
	disconnectListeners()
	
	-- Monitor for unexpected changes and auto-correct
	table.insert(connections, partnerNameLabel:GetPropertyChangedSignal("Text"):Connect(function()
		-- If no custom name is set, store this as the last partner name
		if desiredPartnerName == "" then
			lastPartnerName = partnerNameLabel.Text
			print("Stored last partner name:", lastPartnerName)
		elseif partnerNameLabel.Text ~= desiredPartnerName then
			partnerNameLabel.Text = desiredPartnerName
			print("Partner name was changed unexpectedly. Auto-corrected to:", desiredPartnerName)
		end
	end))

	-- Monitor the confirmation frame partner label too
	table.insert(connections, confirmPartnerLabel:GetPropertyChangedSignal("Text"):Connect(function()
		if desiredPartnerName ~= "" and confirmPartnerLabel.Text ~= desiredPartnerName then
			confirmPartnerLabel.Text = desiredPartnerName
			print("Confirmation partner name was changed unexpectedly. Auto-corrected to:", desiredPartnerName)
		end
	end))

	-- Monitor if the label gets replaced
	table.insert(connections, partnerFrame.ChildAdded:Connect(function(child)
		if child.Name == "NameLabel" then
			partnerNameLabel = child
			if desiredPartnerName ~= "" then
				partnerNameLabel.Text = desiredPartnerName
			end
			setupListeners() -- Re-setup listeners for new label
		end
	end))

	-- Monitor if confirmation partner label gets replaced
	table.insert(connections, confirmationFrame.ChildAdded:Connect(function(child)
		if child.Name == "PartnerLabel" then
			confirmPartnerLabel = child
			if desiredPartnerName ~= "" then
				confirmPartnerLabel.Text = desiredPartnerName
			end
			setupListeners() -- Re-setup listeners for new label
		end
	end))
	
	print("Auto-correction listeners enabled.")
end

-- Setup initial listeners
setupListeners()

-- Monitor when TradeApp.Frame becomes invisible and disconnect listeners
frame:GetPropertyChangedSignal("Visible"):Connect(function()
	if not frame.Visible then
		disconnectListeners()
		-- Clear the desired name so the script stops interfering
		desiredPartnerName = ""
		print("Trade window closed. Auto-correction disabled. Names will function normally until you set them again.")
	else
		setupListeners()
		print("Trade window opened. Auto-correction enabled.")
	end
end)

-- Create the moveable name picker GUI
local namePickerGui = Instance.new("ScreenGui")
namePickerGui.Name = "NamePickerGui"
namePickerGui.ResetOnSpawn = false
namePickerGui.Parent = playerGui

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 300, 0, 180)
mainFrame.Position = UDim2.new(0.5, -150, 0.5, -90)
mainFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
mainFrame.BorderSizePixel = 2
mainFrame.BorderColor3 = Color3.fromRGB(255, 255, 255)
mainFrame.Parent = namePickerGui

local uiCorner = Instance.new("UICorner")
uiCorner.CornerRadius = UDim.new(0, 8)
uiCorner.Parent = mainFrame

-- Title bar for dragging
local titleBar = Instance.new("Frame")
titleBar.Name = "TitleBar"
titleBar.Size = UDim2.new(1, 0, 0, 30)
titleBar.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 8)
titleCorner.Parent = titleBar

local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, 0, 1, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "Enter Partner Name"
titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextSize = 14
titleLabel.Parent = titleBar

-- Text input
local textBox = Instance.new("TextBox")
textBox.Name = "NameTextBox"
textBox.Size = UDim2.new(0.85, 0, 0, 35)
textBox.Position = UDim2.new(0.075, 0, 0.28, 0)
textBox.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
textBox.BorderSizePixel = 1
textBox.BorderColor3 = Color3.fromRGB(100, 100, 100)
textBox.Text = ""
textBox.PlaceholderText = "Enter name..."
textBox.TextColor3 = Color3.fromRGB(255, 255, 255)
textBox.Font = Enum.Font.Gotham
textBox.TextSize = 14
textBox.ClearTextOnFocus = false
textBox.Parent = mainFrame

local textBoxCorner = Instance.new("UICorner")
textBoxCorner.CornerRadius = UDim.new(0, 6)
textBoxCorner.Parent = textBox

-- Submit button
local submitButton = Instance.new("TextButton")
submitButton.Name = "SubmitButton"
submitButton.Size = UDim2.new(0.85, 0, 0, 35)
submitButton.Position = UDim2.new(0.075, 0, 0.55, 0)
submitButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
submitButton.BorderSizePixel = 0
submitButton.Text = "Set Name"
submitButton.TextColor3 = Color3.fromRGB(255, 255, 255)
submitButton.Font = Enum.Font.GothamBold
submitButton.TextSize = 14
submitButton.Parent = mainFrame

local buttonCorner = Instance.new("UICorner")
buttonCorner.CornerRadius = UDim.new(0, 6)
buttonCorner.Parent = submitButton

-- Use Last Partner button
local lastPartnerButton = Instance.new("TextButton")
lastPartnerButton.Name = "LastPartnerButton"
lastPartnerButton.Size = UDim2.new(0.85, 0, 0, 35)
lastPartnerButton.Position = UDim2.new(0.075, 0, 0.78, 0)
lastPartnerButton.BackgroundColor3 = Color3.fromRGB(70, 130, 180)
lastPartnerButton.BorderSizePixel = 0
lastPartnerButton.Text = "Use Last Partner"
lastPartnerButton.TextColor3 = Color3.fromRGB(255, 255, 255)
lastPartnerButton.Font = Enum.Font.GothamBold
lastPartnerButton.TextSize = 14
lastPartnerButton.Parent = mainFrame

local lastButtonCorner = Instance.new("UICorner")
lastButtonCorner.CornerRadius = UDim.new(0, 6)
lastButtonCorner.Parent = lastPartnerButton

-- Make the GUI draggable
local dragging = false
local dragInput, mousePos, framePos

titleBar.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		mousePos = input.Position
		framePos = mainFrame.Position
		
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)

titleBar.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
		dragInput = input
	end
end)

game:GetService("UserInputService").InputChanged:Connect(function(input)
	if input == dragInput and dragging then
		local delta = input.Position - mousePos
		mainFrame.Position = UDim2.new(
			framePos.X.Scale,
			framePos.X.Offset + delta.X,
			framePos.Y.Scale,
			framePos.Y.Offset + delta.Y
		)
	end
end)

-- Submit button functionality
submitButton.MouseButton1Click:Connect(function()
	local partnerName = textBox.Text
	
	if partnerName ~= "" then
		setPartnerName(partnerName)
		
		-- Show a confirmation
		submitButton.Text = "✓ Set!"
		submitButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
		task.wait(0.5)
		submitButton.Text = "Set Name"
		submitButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
	end
end)

-- Last Partner button functionality
lastPartnerButton.MouseButton1Click:Connect(function()
	if lastPartnerName ~= "" then
		textBox.Text = lastPartnerName
		setPartnerName(lastPartnerName)
		
		-- Show a confirmation
		lastPartnerButton.Text = "✓ Applied!"
		lastPartnerButton.BackgroundColor3 = Color3.fromRGB(30, 150, 200)
		task.wait(0.5)
		lastPartnerButton.Text = "Use Last Partner"
		lastPartnerButton.BackgroundColor3 = Color3.fromRGB(70, 130, 180)
	else
		-- Show error if no last partner exists
		lastPartnerButton.Text = "No partner yet"
		lastPartnerButton.BackgroundColor3 = Color3.fromRGB(180, 70, 70)
		task.wait(1)
		lastPartnerButton.Text = "Use Last Partner"
		lastPartnerButton.BackgroundColor3 = Color3.fromRGB(70, 130, 180)
	end
end)

-- Allow Enter key to submit
textBox.FocusLost:Connect(function(enterPressed)
	if enterPressed and textBox.Text ~= "" then
		submitButton.MouseButton1Click:Fire()
	end
end)
