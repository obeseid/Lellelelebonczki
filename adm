-- LocalScript in StarterPlayer > StarterPlayerScripts or StarterGui

local Players = game:GetService("Players")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Wait for TradeApp
local tradeApp = playerGui:WaitForChild("TradeApp")
local frame = tradeApp:WaitForChild("Frame")
local negotiationFrame = frame:WaitForChild("NegotiationFrame")
local header = negotiationFrame:WaitForChild("Header")

-- Get the name label frames
local youFrame = header:WaitForChild("YouFrame")
local partnerFrame = header:WaitForChild("PartnerFrame")
local yourNameLabel = youFrame:WaitForChild("NameLabel")
local partnerNameLabel = partnerFrame:WaitForChild("NameLabel")

-- Set your name immediately
yourNameLabel.Text = player.Name

-- Get Body elements for accept functionality
local body = negotiationFrame:WaitForChild("Body")
local myOffer = body:WaitForChild("MyOffer")
local partnerOffer = body:WaitForChild("PartnerOffer")
local myAcceptedLabel = myOffer:WaitForChild("Accepted")
local partnerAcceptedLabel = partnerOffer:WaitForChild("Accepted")
local acceptButton = body:WaitForChild("Accept")
local declineButton = body:WaitForChild("Decline")

-- Get ConfirmationFrame elements
local confirmationFrame = frame:WaitForChild("ConfirmationFrame")
local confirmBody = confirmationFrame:WaitForChild("Body")
local confirmMyOffer = confirmBody:WaitForChild("MyOffer")
local confirmPartnerOffer = confirmBody:WaitForChild("PartnerOffer")
local confirmMyAcceptedLabel = confirmMyOffer:WaitForChild("Accepted")
local confirmPartnerAcceptedLabel = confirmPartnerOffer:WaitForChild("Accepted")
local confirmAcceptButton = confirmationFrame:WaitForChild("Accept")

-- Get name labels in ConfirmationFrame
local confirmHeader = confirmationFrame:WaitForChild("Header")
local confirmYouFrame = confirmHeader:WaitForChild("YouFrame")
local confirmPartnerFrame = confirmHeader:WaitForChild("PartnerFrame")
local confirmYouLabel = confirmYouFrame:WaitForChild("PartnerLabel")
local confirmPartnerLabel = confirmPartnerFrame:WaitForChild("PartnerLabel")

-- Hide both Accepted labels initially
myAcceptedLabel.Visible = false
partnerAcceptedLabel.Visible = false

-- Accept button functionality
acceptButton.MouseButton1Click:Connect(function()
	myAcceptedLabel.Visible = true
	
	-- Wait 2 seconds then show ConfirmationFrame
	task.wait(2)
	negotiationFrame.Visible = false
	
	-- Set names in ConfirmationFrame
	confirmYouLabel.Text = player.Name
	confirmPartnerLabel.Text = partnerNameLabel.Text
	
	-- Hide both accepted labels in ConfirmationFrame
	confirmMyAcceptedLabel.Visible = false
	confirmPartnerAcceptedLabel.Visible = false
	
	-- Show ConfirmationFrame
	confirmationFrame.Visible = true
end)

-- Decline button functionality
declineButton.MouseButton1Click:Connect(function()
	negotiationFrame.Visible = false
	-- Reset accepted labels when declining
	myAcceptedLabel.Visible = false
	partnerAcceptedLabel.Visible = false
end)

-- ConfirmationFrame Accept button functionality
confirmAcceptButton.MouseButton1Click:Connect(function()
	confirmMyAcceptedLabel.Visible = true
	
	-- Wait 3 seconds then hide ConfirmationFrame
	task.wait(3)
	confirmationFrame.Visible = false
end)

-- Create the moveable name picker GUI
local namePickerGui = Instance.new("ScreenGui")
namePickerGui.Name = "NamePickerGui"
namePickerGui.ResetOnSpawn = false
namePickerGui.Parent = playerGui

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 300, 0, 150)
mainFrame.Position = UDim2.new(0.5, -150, 0.5, -75)
mainFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
mainFrame.BorderSizePixel = 2
mainFrame.BorderColor3 = Color3.fromRGB(255, 255, 255)
mainFrame.Parent = namePickerGui

local uiCorner = Instance.new("UICorner")
uiCorner.CornerRadius = UDim.new(0, 8)
uiCorner.Parent = mainFrame

-- Title bar for dragging
local titleBar = Instance.new("Frame")
titleBar.Name = "TitleBar"
titleBar.Size = UDim2.new(1, 0, 0, 30)
titleBar.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 8)
titleCorner.Parent = titleBar

local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, 0, 1, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "Enter Partner Name"
titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextSize = 14
titleLabel.Parent = titleBar

-- Text input
local textBox = Instance.new("TextBox")
textBox.Name = "NameTextBox"
textBox.Size = UDim2.new(0.85, 0, 0, 35)
textBox.Position = UDim2.new(0.075, 0, 0.35, 0)
textBox.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
textBox.BorderSizePixel = 1
textBox.BorderColor3 = Color3.fromRGB(100, 100, 100)
textBox.Text = ""
textBox.PlaceholderText = "Enter name..."
textBox.TextColor3 = Color3.fromRGB(255, 255, 255)
textBox.Font = Enum.Font.Gotham
textBox.TextSize = 14
textBox.ClearTextOnFocus = false
textBox.Parent = mainFrame

local textBoxCorner = Instance.new("UICorner")
textBoxCorner.CornerRadius = UDim.new(0, 6)
textBoxCorner.Parent = textBox

-- Submit button
local submitButton = Instance.new("TextButton")
submitButton.Name = "SubmitButton"
submitButton.Size = UDim2.new(0.4, 0, 0, 35)
submitButton.Position = UDim2.new(0.3, 0, 0.7, 0)
submitButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
submitButton.BorderSizePixel = 0
submitButton.Text = "Set Name"
submitButton.TextColor3 = Color3.fromRGB(255, 255, 255)
submitButton.Font = Enum.Font.GothamBold
submitButton.TextSize = 14
submitButton.Parent = mainFrame

local buttonCorner = Instance.new("UICorner")
buttonCorner.CornerRadius = UDim.new(0, 6)
buttonCorner.Parent = submitButton

-- Make the GUI draggable
local dragging = false
local dragInput, mousePos, framePos

titleBar.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		mousePos = input.Position
		framePos = mainFrame.Position
		
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)

titleBar.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
		dragInput = input
	end
end)

game:GetService("UserInputService").InputChanged:Connect(function(input)
	if input == dragInput and dragging then
		local delta = input.Position - mousePos
		mainFrame.Position = UDim2.new(
			framePos.X.Scale,
			framePos.X.Offset + delta.X,
			framePos.Y.Scale,
			framePos.Y.Offset + delta.Y
		)
	end
end)

-- Submit button functionality
submitButton.MouseButton1Click:Connect(function()
	local partnerName = textBox.Text
	
	if partnerName ~= "" then
		partnerNameLabel.Text = partnerName
		
		-- Show a confirmation
		submitButton.Text = "✓ Set!"
		submitButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
		task.wait(0.5)
		submitButton.Text = "Set Name"
		submitButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
	end
end)

-- Allow Enter key to submit
textBox.FocusLost:Connect(function(enterPressed)
	if enterPressed and textBox.Text ~= "" then
		submitButton.MouseButton1Click:Fire()
	end
end)

-- Show Trade button
local showTradeButton = Instance.new("TextButton")
showTradeButton.Name = "ShowTradeButton"
showTradeButton.Size = UDim2.new(0.85, 0, 0, 35)
showTradeButton.Position = UDim2.new(0.075, 0, 0.7, 0)
showTradeButton.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
showTradeButton.BorderSizePixel = 0
showTradeButton.Text = "Show Trade Window"
showTradeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
showTradeButton.Font = Enum.Font.GothamBold
showTradeButton.TextSize = 14
showTradeButton.Parent = mainFrame

local showTradeCorner = Instance.new("UICorner")
showTradeCorner.CornerRadius = UDim.new(0, 6)
showTradeCorner.Parent = showTradeButton

-- Adjust submit button position to make room
submitButton.Size = UDim2.new(0.4, 0, 0, 30)
submitButton.Position = UDim2.new(0.3, 0, 0.5, 0)

-- Adjust main frame height to fit new button
mainFrame.Size = UDim2.new(0, 300, 0, 180)
mainFrame.Position = UDim2.new(0.5, -150, 0.5, -90)

-- Show Trade button functionality
showTradeButton.MouseButton1Click:Connect(function()
	showTradeButton.Text = "Opening in 1 second..."
	showTradeButton.BackgroundColor3 = Color3.fromRGB(0, 100, 180)
	
	task.wait(1)
	
	-- Make sure both the main Frame and NegotiationFrame are visible
	frame.Visible = true
	negotiationFrame.Visible = true
	tradeApp.Enabled = true -- Also ensure the ScreenGui itself is enabled
	
	showTradeButton.Text = "✓ Trade Window Opened"
	showTradeButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
	task.wait(1)
	showTradeButton.Text = "Show Trade Window"
	showTradeButton.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
end)
