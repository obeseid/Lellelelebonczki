-- Services
local players = game:GetService("Players")
local lp = players.LocalPlayer
local playerGui = lp:WaitForChild("PlayerGui")
local VIM = game:GetService("VirtualInputManager")
local Camera = workspace.CurrentCamera

-- State
local currentTask
local shouldStop = false
local isPaused = false
local currentIslandIndex = 1
local clickLoop = nil
local islands = {
	"Jungle Island",
	"Lunar Islands",
	"Volcano Island"
}

-- Virtual Input Manager Functions
local function getScreenSize()
	return Camera.ViewportSize
end

local function getClickPosition()
	local screenSize = getScreenSize()
	local x = screenSize.X - 300  -- 300 pixels from right edge
	local y = 30                   -- 30 pixels from top
	return x, y
end

local function clickAt(x, y)
	VIM:SendMouseButtonEvent(x, y, 0, true, game, 0)  -- Mouse down
	task.wait(0.05)
	VIM:SendMouseButtonEvent(x, y, 0, false, game, 0) -- Mouse up
end

local function startAutoClicker()
	if clickLoop then
		task.cancel(clickLoop)
	end
	
	clickLoop = task.spawn(function()
		while true do
			if not isPaused then
				local x, y = getClickPosition()
				clickAt(x, y)
			end
			task.wait(0.5)
		end
	end)
end

-- Create GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "HorseCatcherGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 220, 0, 80)
frame.Position = UDim2.new(0, 10, 0, 10)
frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
frame.BorderSizePixel = 0
frame.Parent = screenGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 8)
corner.Parent = frame

local islandLabel = Instance.new("TextLabel")
islandLabel.Size = UDim2.new(1, -20, 0, 30)
islandLabel.Position = UDim2.new(0, 10, 0, 10)
islandLabel.BackgroundTransparency = 1
islandLabel.Text = "High Islands"
islandLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
islandLabel.TextSize = 14
islandLabel.Font = Enum.Font.GothamBold
islandLabel.TextXAlignment = Enum.TextXAlignment.Left
islandLabel.Parent = frame

local pauseButton = Instance.new("TextButton")
pauseButton.Size = UDim2.new(1, -20, 0, 30)
pauseButton.Position = UDim2.new(0, 10, 0, 45)
pauseButton.BackgroundColor3 = Color3.fromRGB(60, 180, 75)
pauseButton.Text = "Pause"
pauseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
pauseButton.TextSize = 14
pauseButton.Font = Enum.Font.GothamBold
pauseButton.Parent = frame

local buttonCorner = Instance.new("UICorner")
buttonCorner.CornerRadius = UDim.new(0, 6)
buttonCorner.Parent = pauseButton

-- Island Travel Function
local function movePlayerToIsland(islandName)
	local char = lp.Character or lp.CharacterAdded:Wait()
	
	local islandFolder = workspace.Islands:FindFirstChild(islandName)
	if not islandFolder then
		warn("Island not found:", islandName)
		return false
	end
	
	print("Attempting to travel to:", islandName)
	
	-- Try to invoke the travel system properly
	local References = game:GetService("ReplicatedStorage"):WaitForChild("References")
	local Utilities = require(References).Utilities
	
	-- Use the same method as the game's TravelHandler
	local success, result = pcall(function()
		return Utilities.Network:InvokeServer("Travel", "Travel", islandName, nil, nil)
	end)
	
	if success then
		print("Travel request successful for:", islandName)
		print("Result:", result)
		
		-- Move character model into the island folder
		char.Parent = islandFolder
		
		task.wait(3) -- Wait for targets to load in
		return true
	else
		warn("Travel request failed:", result)
		
		-- Fallback: Just move the character model
		char.Parent = islandFolder
		task.wait(3)
		return true
	end
end

-- Follow Logic
local function followLoopFrom(folder)
	-- Signal the old task to stop
	shouldStop = true
	task.wait(0.3) -- Give it time to stop
	shouldStop = false
	
	local function getValidTargets()
		local targets = {}
		for _, model in ipairs(folder:GetChildren()) do
			if model:IsA("Model") and model:FindFirstChild("HumanoidRootPart") and model:FindFirstChild("maneMesh") then
				table.insert(targets, model)
			end
		end
		return targets
	end
	
	currentTask = task.spawn(function()
		local currentTarget = nil
		local lastSwitch = 0
		local noTargetChecks = 0
		
		while not shouldStop do
			if isPaused then
				task.wait(0.5)
				continue
			end
			
			-- Refresh character and hrp references each loop
			local char = lp.Character
			if not char then
				task.wait(0.2)
				continue
			end
			
			local hrp = char:FindFirstChild("HumanoidRootPart")
			if not hrp then
				task.wait(0.2)
				continue
			end
			
			local now = tick()
			local targets = getValidTargets()
			
			-- Check if no valid targets exist
			if #targets == 0 then
				noTargetChecks = noTargetChecks + 1
				
				if noTargetChecks >= 3 then -- Check 3 times to be sure
					print("No valid targets found in:", islands[currentIslandIndex])
					
					-- Try next island
					currentIslandIndex = currentIslandIndex + 1
					if currentIslandIndex > #islands then
						print("No more islands to check. Restarting from first island.")
						currentIslandIndex = 1
					end
					
					local nextIsland = islands[currentIslandIndex]
					print("Switching to:", nextIsland)
					
					if movePlayerToIsland(nextIsland) then
						local newFolder = workspace.Islands:FindFirstChild(nextIsland)
						if newFolder then
							followLoopFrom(newFolder)
							return -- Exit current loop
						end
					end
					
					noTargetChecks = 0
				end
				
				task.wait(1)
			else
				noTargetChecks = 0 -- Reset counter when targets are found
				
				-- Switch target every 15 seconds or if lost
				if not currentTarget or not currentTarget.Parent or now - lastSwitch >= 15 then
					local newTarget
					repeat
						newTarget = targets[math.random(1, #targets)]
					until newTarget ~= currentTarget or #targets == 1
					
					currentTarget = newTarget
					lastSwitch = now
					
					local targetHRP = currentTarget:FindFirstChild("HumanoidRootPart")
					if targetHRP then
						hrp.CFrame = targetHRP.CFrame * CFrame.new(0, 0, -5)
					end
				end
				
				-- Follow current target
				if currentTarget and currentTarget:FindFirstChild("HumanoidRootPart") then
					local targetHRP = currentTarget.HumanoidRootPart
					local distance = (hrp.Position - targetHRP.Position).Magnitude
					
					if distance > 6 then
						char:PivotTo(CFrame.new(targetHRP.Position + Vector3.new(0, 0, -4)))
					end
					
					if distance > 30 then
						hrp.CFrame = targetHRP.CFrame * CFrame.new(0, 0, -4)
					end
				end
				
				task.wait(0.2)
			end
		end
	end)
end

-- Pause/Resume button
pauseButton.MouseButton1Click:Connect(function()
	isPaused = not isPaused
	if isPaused then
		pauseButton.Text = "Resume"
		pauseButton.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
	else
		pauseButton.Text = "Pause"
		pauseButton.BackgroundColor3 = Color3.fromRGB(60, 180, 75)
	end
end)

-- Start auto-clicker
startAutoClicker()

-- Auto-start scanning Royal Island
followLoopFrom(workspace.Islands["Jungle Island"])
