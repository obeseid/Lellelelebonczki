-- eeeeeeeeeeeeghggggggggggggg

local Players = game:GetService("Players")
local player = Players.LocalPlayer
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- Configuration
local SPEED = 50
local ROTATION_SPEED = 5
local CHECKPOINT_TIMEOUT = 3 -- seconds to wait before switching to log pulling

-- Model list
local modelList = {
    {name = "{6042dc5b-0335-4047-8248-f9633ada55e7}", displayName = "karolina"},
    {name = "{adac3b42-a4c8-4008-b3eb-3326a8c333ec}", displayName = "szchoch"},
    {name = "{ff8c36e8-ad2d-4a8e-bf6a-3444f7113351}", displayName = "diego"},
    {name = "{dbb2a7c6-9b77-45b9-8e2d-20c5a8dd1dac}", displayName = "siostra"},
    {name = "{4ecb439c-9f5e-4633-912f-ec59935a6cfe}", displayName = "test hors"}
}

-- State variables
local isRunning = false
local isPaused = false
local selectedModel = nil
local selectedModelName = modelList[1].displayName
local dropdownOpen = false
local lastCheckpointTime = tick()
local currentMode = "checkpoint" -- "checkpoint" or "log_pulling"

-- Anti-AFK Function (always active)
local VirtualUser = game:GetService("VirtualUser")

player.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
    print("Anti-AFK: Prevented idle kick")
end)

-- Additional anti-afk measures
spawn(function()
    while true do
        wait(300) -- Every 5 minutes
        VirtualUser:CaptureController()
        VirtualUser:Button1Down(Vector2.new(0, 0))
        wait(0.1)
        VirtualUser:Button1Up(Vector2.new(0, 0))
    end
end)

-- Create GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "CheckpointFlightGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

-- Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 250, 0, 220)
mainFrame.Position = UDim2.new(0, 10, 0, 10)
mainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui

local uiCorner = Instance.new("UICorner")
uiCorner.CornerRadius = UDim.new(0, 10)
uiCorner.Parent = mainFrame

-- Title
local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, 0, 0, 35)
titleLabel.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
titleLabel.BorderSizePixel = 0
titleLabel.Text = "Auto Trainer"
titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
titleLabel.TextSize = 18
titleLabel.Font = Enum.Font.GothamBold
titleLabel.Parent = mainFrame

local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 10)
titleCorner.Parent = titleLabel

-- Model Selection Label
local modelLabel = Instance.new("TextLabel")
modelLabel.Size = UDim2.new(1, -20, 0, 20)
modelLabel.Position = UDim2.new(0, 10, 0, 45)
modelLabel.BackgroundTransparency = 1
modelLabel.Text = "Select Model:"
modelLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
modelLabel.TextSize = 12
modelLabel.Font = Enum.Font.GothamBold
modelLabel.TextXAlignment = Enum.TextXAlignment.Left
modelLabel.Parent = mainFrame

-- Dropdown Button
local dropdownButton = Instance.new("TextButton")
dropdownButton.Size = UDim2.new(1, -20, 0, 35)
dropdownButton.Position = UDim2.new(0, 10, 0, 65)
dropdownButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
dropdownButton.BorderSizePixel = 0
dropdownButton.Text = selectedModelName .. " ▼"
dropdownButton.TextColor3 = Color3.fromRGB(255, 255, 255)
dropdownButton.TextSize = 14
dropdownButton.Font = Enum.Font.Gotham
dropdownButton.Parent = mainFrame

local dropdownCorner = Instance.new("UICorner")
dropdownCorner.CornerRadius = UDim.new(0, 6)
dropdownCorner.Parent = dropdownButton

-- Dropdown Frame (hidden by default)
local dropdownFrame = Instance.new("Frame")
dropdownFrame.Size = UDim2.new(1, -20, 0, #modelList * 32)
dropdownFrame.Position = UDim2.new(0, 10, 0, 102)
dropdownFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
dropdownFrame.BorderSizePixel = 0
dropdownFrame.Visible = false
dropdownFrame.ZIndex = 10
dropdownFrame.Parent = mainFrame

local dropdownFrameCorner = Instance.new("UICorner")
dropdownFrameCorner.CornerRadius = UDim.new(0, 6)
dropdownFrameCorner.Parent = dropdownFrame

-- Create dropdown options
for i, modelData in ipairs(modelList) do
    local optionButton = Instance.new("TextButton")
    optionButton.Size = UDim2.new(1, 0, 0, 30)
    optionButton.Position = UDim2.new(0, 0, 0, (i-1) * 32)
    optionButton.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    optionButton.BorderSizePixel = 0
    optionButton.Text = modelData.displayName
    optionButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    optionButton.TextSize = 13
    optionButton.Font = Enum.Font.Gotham
    optionButton.ZIndex = 11
    optionButton.Parent = dropdownFrame
    
    optionButton.MouseButton1Click:Connect(function()
        selectedModelName = modelData.displayName
        dropdownButton.Text = selectedModelName .. " ▼"
        dropdownFrame.Visible = false
        dropdownOpen = false
        
        -- Find and set the selected model
        selectedModel = workspace.Islands["Training Island"]:FindFirstChild(modelData.name)
        if selectedModel then
            print("Selected model: " .. modelData.displayName)
        else
            warn("Model " .. modelData.displayName .. " not found!")
        end
    end)
    
    -- Hover effect
    optionButton.MouseEnter:Connect(function()
        optionButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    end)
    
    optionButton.MouseLeave:Connect(function()
        optionButton.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    end)
end

-- Dropdown button click
dropdownButton.MouseButton1Click:Connect(function()
    dropdownOpen = not dropdownOpen
    dropdownFrame.Visible = dropdownOpen
    dropdownButton.Text = selectedModelName .. (dropdownOpen and " ▲" or " ▼")
end)

-- Mode Label
local modeLabel = Instance.new("TextLabel")
modeLabel.Size = UDim2.new(1, -20, 0, 22)
modeLabel.Position = UDim2.new(0, 10, 0, 110)
modeLabel.BackgroundTransparency = 1
modeLabel.Text = "Mode: Checkpoints"
modeLabel.TextColor3 = Color3.fromRGB(52, 152, 219)
modeLabel.TextSize = 12
modeLabel.Font = Enum.Font.GothamBold
modeLabel.TextXAlignment = Enum.TextXAlignment.Left
modeLabel.Parent = mainFrame

-- Status Label
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, -20, 0, 25)
statusLabel.Position = UDim2.new(0, 10, 0, 132)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "Status: Stopped"
statusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
statusLabel.TextSize = 13
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextXAlignment = Enum.TextXAlignment.Left
statusLabel.Parent = mainFrame

-- Progress Label
local progressLabel = Instance.new("TextLabel")
progressLabel.Size = UDim2.new(1, -20, 0, 22)
progressLabel.Position = UDim2.new(0, 10, 0, 157)
progressLabel.BackgroundTransparency = 1
progressLabel.Text = "Waiting..."
progressLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
progressLabel.TextSize = 11
progressLabel.Font = Enum.Font.Gotham
progressLabel.TextXAlignment = Enum.TextXAlignment.Left
progressLabel.Parent = mainFrame

-- Start Button
local startButton = Instance.new("TextButton")
startButton.Size = UDim2.new(1, -20, 0, 35)
startButton.Position = UDim2.new(0, 10, 1, -45)
startButton.BackgroundColor3 = Color3.fromRGB(46, 204, 113)
startButton.BorderSizePixel = 0
startButton.Text = "Start"
startButton.TextColor3 = Color3.fromRGB(255, 255, 255)
startButton.TextSize = 16
startButton.Font = Enum.Font.GothamBold
startButton.Parent = mainFrame

local startCorner = Instance.new("UICorner")
startCorner.CornerRadius = UDim.new(0, 8)
startCorner.Parent = startButton

-- Initialize first model
selectedModel = workspace.Islands["Training Island"]:FindFirstChild(modelList[1].name)

-- Function to update status display
local function updateStatus()
    if isRunning then
        if isPaused then
            statusLabel.Text = "Status: Paused"
            statusLabel.TextColor3 = Color3.fromRGB(241, 196, 15)
        else
            statusLabel.Text = "Status: Running"
            statusLabel.TextColor3 = Color3.fromRGB(46, 204, 113)
        end
    else
        statusLabel.Text = "Status: Stopped"
        statusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    end
end

-- Function to check if log model exists
local function findLogModel()
    for _, model in ipairs(workspace:GetChildren()) do
        if model:IsA("Model") then
            local hasBonfireLog1 = model:FindFirstChild("Meshes/Bonfire Log_Bonfire Log")
            local hasBonfireLog2 = model:FindFirstChild("Meshes/Bonfire Log_Bonfire Log 2")
            local hasShowWhenDragged = model:FindFirstChild("ShowWhenDrgged")
            
            if hasBonfireLog1 and hasBonfireLog2 and hasShowWhenDragged then
                return model
            end
        end
    end
    return nil
end

-- Function to get all checkpoint markers
local function getCheckpointMarkers()
    local markers = {}
    for _, child in ipairs(workspace:GetChildren()) do
        if child.Name == "CheckpointMarker" and child:FindFirstChild("Neon") then
            table.insert(markers, child)
        end
    end
    return markers
end

-- Function to move model to a target position
local function moveToPosition(targetPos)
    if not selectedModel then return false end
    
    local primaryPart = selectedModel.PrimaryPart or selectedModel:FindFirstChildWhichIsA("BasePart")
    if not primaryPart then return false end
    
    local startPos = primaryPart.Position
    local distance = (targetPos - startPos).Magnitude
    local duration = distance / SPEED
    local startTime = tick()
    
    while tick() - startTime < duration do
        while isPaused and isRunning do
            wait(0.1)
        end
        
        if not isRunning then
            return false
        end
        
        local alpha = (tick() - startTime) / duration
        local currentPos = startPos:Lerp(targetPos, alpha)
        
        local direction = (targetPos - currentPos).Unit
        local lookCFrame = CFrame.lookAt(currentPos, currentPos + direction)
        
        if selectedModel.PrimaryPart then
            selectedModel:SetPrimaryPartCFrame(lookCFrame)
        else
            primaryPart.CFrame = lookCFrame
        end
        
        RunService.Heartbeat:Wait()
    end
    
    local finalCFrame = CFrame.lookAt(targetPos, targetPos + (targetPos - startPos).Unit)
    if selectedModel.PrimaryPart then
        selectedModel:SetPrimaryPartCFrame(finalCFrame)
    else
        primaryPart.CFrame = finalCFrame
    end
    
    return true
end

-- Function to teleport to log pulling area and press E
local function startLogPulling()
    currentMode = "log_pulling"
    modeLabel.Text = "Mode: Log Pulling"
    modeLabel.TextColor3 = Color3.fromRGB(230, 126, 34)
    progressLabel.Text = "Teleporting to log area..."
    
    local interactionPart = workspace.Islands["Training Island"]["Log & Tire Pulling"]["Trigger (Log Pulling)"].InteractionPart
    
    if not selectedModel then return false end
    
    local primaryPart = selectedModel.PrimaryPart or selectedModel:FindFirstChildWhichIsA("BasePart")
    if not primaryPart then return false end
    
    -- Teleport to interaction part
    if selectedModel.PrimaryPart then
        selectedModel:SetPrimaryPartCFrame(CFrame.new(interactionPart.Position))
    else
        primaryPart.CFrame = CFrame.new(interactionPart.Position)
    end
    
    wait(0.5)
    
    -- Press E
    progressLabel.Text = "Pressing E..."
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
    wait(0.1)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
    
    wait(1)
    
    return true
end

-- Function to fly checkpoints with log
local function flyCheckpointsWithLog(logModel)
    progressLabel.Text = "Flying with log..."
    
    local markers = getCheckpointMarkers()
    
    if #markers == 0 then
        progressLabel.Text = "No checkpoints found!"
        return
    end
    
    -- Sort markers by name if they have numeric names
    table.sort(markers, function(a, b)
        local numA = tonumber(a.Name:match("%d+"))
        local numB = tonumber(b.Name:match("%d+"))
        if numA and numB then
            return numA < numB
        end
        return a.Name < b.Name
    end)
    
    for i, marker in ipairs(markers) do
        if not isRunning then break end
        
        while isPaused and isRunning do
            wait(0.1)
        end
        
        progressLabel.Text = "Checkpoint: " .. i .. "/" .. #markers
        
        local neonPart = marker:FindFirstChild("Neon")
        if neonPart then
            local targetPos = neonPart.Position
            local success = moveToPosition(targetPos)
            if not success then break end
        end
        
        wait(0.3)
        
        -- Check if log model still exists
        if not logModel.Parent then
            progressLabel.Text = "Log delivered!"
            break
        end
    end
end

-- Main flight function
local function startFlight()
    while isRunning do
        -- Check for checkpoint markers
        local markers = getCheckpointMarkers()
        
        if #markers > 0 then
            -- Checkpoint mode
            if currentMode ~= "checkpoint" then
                currentMode = "checkpoint"
                modeLabel.Text = "Mode: Checkpoints"
                modeLabel.TextColor3 = Color3.fromRGB(52, 152, 219)
            end
            
            lastCheckpointTime = tick()
            
            -- Sort markers
            table.sort(markers, function(a, b)
                local numA = tonumber(a.Name:match("%d+"))
                local numB = tonumber(b.Name:match("%d+"))
                if numA and numB then
                    return numA < numB
                end
                return a.Name < b.Name
            end)
            
            for i, marker in ipairs(markers) do
                if not isRunning then break end
                
                while isPaused and isRunning do
                    wait(0.1)
                end
                
                progressLabel.Text = "Checkpoint: " .. i .. "/" .. #markers
                
                local neonPart = marker:FindFirstChild("Neon")
                if neonPart then
                    local success = moveToPosition(neonPart.Position)
                    if not success then break end
                end
                
                wait(0.3)
                
                -- Recheck markers after each checkpoint
                markers = getCheckpointMarkers()
                if #markers == 0 then
                    break
                end
            end
        else
            -- No checkpoints found, check timeout
            if tick() - lastCheckpointTime >= CHECKPOINT_TIMEOUT then
                -- Switch to log pulling mode
                progressLabel.Text = "No checkpoints, switching mode..."
                wait(0.5)
                
                startLogPulling()
                
                -- Wait for log model to appear
                local waitTime = 0
                while isRunning and waitTime < 10 do
                    local logModel = findLogModel()
                    if logModel then
                        progressLabel.Text = "Log detected! Flying..."
                        wait(0.5)
                        flyCheckpointsWithLog(logModel)
                        break
                    end
                    wait(0.5)
                    waitTime = waitTime + 0.5
                end
                
                -- Reset timer after log pulling attempt
                lastCheckpointTime = tick()
            else
                progressLabel.Text = "Waiting for checkpoints..."
                wait(0.5)
            end
        end
        
        if isRunning then
            wait(0.5)
        end
    end
end

-- Button handlers
startButton.MouseButton1Click:Connect(function()
    if not selectedModel then
        warn("Please select a valid model first!")
        return
    end
    
    if not isRunning then
        -- Start the script
        isRunning = true
        isPaused = false
        lastCheckpointTime = tick()
        startButton.Text = "Pause"
        startButton.BackgroundColor3 = Color3.fromRGB(241, 196, 15)
        updateStatus()
        coroutine.wrap(startFlight)()
    elseif isPaused then
        -- Resume from pause
        isPaused = false
        startButton.Text = "Pause"
        startButton.BackgroundColor3 = Color3.fromRGB(241, 196, 15)
        updateStatus()
    else
        -- Pause
        isPaused = true
        startButton.Text = "Resume"
        startButton.BackgroundColor3 = Color3.fromRGB(52, 152, 219)
        updateStatus()
    end
end)

updateStatus()
print("Enhanced Auto Trainer loaded successfully!")
