-- Horse Scanner with Error Handling
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Mane Texture IDs to search for
local maneTextures = {
    ["rbxassetid://136373168220543"] = "Pastel Streaks",
    ["rbxassetid://116165213056086"] = "Winter Streaks",
    ["rbxassetid://11509046725"] = "Cow Print",
    ["rbxassetid://8895902468"] = "Zebra Print",
    ["rbxassetid://103883884513514"] = "Dusty Fade",
    ["rbxassetid://11509043446"] = "Pink Cow Print",
    ["rbxassetid://111500380221658"] = "Sunrise Streaks",
    ["rbxassetid://112405515165803"] = "Jaguar Spots",
    ["rbxassetid://12859587687"] = "Tiger Stripes",
    ["rbxassetid://86178361529080"] = "Cracked Lava Fade",
    ["rbxassetid://9783778257"] = "Leathery",
    ["rbxassetid://112458560900077"] = "Snowy Glacier Fade",
    ["rbxassetid://85795242225613"] = "Deep Space"
}

-- Body Texture IDs to search for
local bodyTextures = {
    ["rbxassetid://113103040884654"] = "Blowing Snow",
    ["rbxassetid://130845145281644"] = "Mother of Pearl",
    ["rbxassetid://135058641443394"] = "Dusty Brindle",
    ["rbxassetid://94920612359921"] = "Glacier Chimera",
    ["rbxassetid://127786237142282"] = "Mountain Sunrise",
    ["rbxassetid://73022658037146"] = "Jaguar",
    ["rbxassetid://123342212722176"] = "Deep Space",
    ["rbxassetid://94361314630149"] = "Cracked Lava"
}

-- Create GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "HorseScannerGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 400, 0, 450)
mainFrame.Position = UDim2.new(0, 10, 0, 10)
mainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui

local uiCorner = Instance.new("UICorner")
uiCorner.CornerRadius = UDim.new(0, 10)
uiCorner.Parent = mainFrame

-- Title bar
local titleBar = Instance.new("Frame")
titleBar.Name = "TitleBar"
titleBar.Size = UDim2.new(1, 0, 0, 40)
titleBar.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 10)
titleCorner.Parent = titleBar

local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, -50, 1, 0)
titleLabel.Position = UDim2.new(0, 10, 0, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "üê¥ Horse Scanner"
titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
titleLabel.TextSize = 18
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.Parent = titleBar

-- Close button
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 30, 0, 30)
closeBtn.Position = UDim2.new(1, -35, 0, 5)
closeBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
closeBtn.Text = "X"
closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
closeBtn.TextSize = 16
closeBtn.Font = Enum.Font.GothamBold
closeBtn.Parent = titleBar

local closeBtnCorner = Instance.new("UICorner")
closeBtnCorner.CornerRadius = UDim.new(0, 6)
closeBtnCorner.Parent = closeBtn

closeBtn.MouseButton1Click:Connect(function()
    screenGui:Destroy()
end)

-- Scan button
local scanBtn = Instance.new("TextButton")
scanBtn.Size = UDim2.new(1, -20, 0, 35)
scanBtn.Position = UDim2.new(0, 10, 0, 50)
scanBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 250)
scanBtn.Text = "üîç Scan Island"
scanBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
scanBtn.TextSize = 16
scanBtn.Font = Enum.Font.GothamBold
scanBtn.Parent = mainFrame

local scanBtnCorner = Instance.new("UICorner")
scanBtnCorner.CornerRadius = UDim.new(0, 8)
scanBtnCorner.Parent = scanBtn

-- Results scroll frame
local scrollFrame = Instance.new("ScrollingFrame")
scrollFrame.Size = UDim2.new(1, -20, 1, -100)
scrollFrame.Position = UDim2.new(0, 10, 0, 95)
scrollFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
scrollFrame.BorderSizePixel = 0
scrollFrame.ScrollBarThickness = 6
scrollFrame.Parent = mainFrame

local scrollCorner = Instance.new("UICorner")
scrollCorner.CornerRadius = UDim.new(0, 8)
scrollCorner.Parent = scrollFrame

local listLayout = Instance.new("UIListLayout")
listLayout.Padding = UDim.new(0, 5)
listLayout.SortOrder = Enum.SortOrder.LayoutOrder
listLayout.Parent = scrollFrame

-- Make GUI draggable
local dragging = false
local dragInput, dragStart, startPos

local function updateInput(input)
    local delta = input.Position - dragStart
    mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

titleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = mainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

titleBar.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

game:GetService("UserInputService").InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        updateInput(input)
    end
end)

-- Helper function to safely check material
local function checkMaterial(mesh)
    -- Use pcall to catch errors when accessing properties
    local success, result = pcall(function()
        if not mesh then return nil end
        
        -- Check if it's a mesh type that can have Material property
        if not (mesh:IsA("MeshPart") or mesh:IsA("SpecialMesh") or mesh:IsA("Part")) then
            return nil
        end
        
        -- Check if the object actually has Material and Color properties
        if not mesh.Material or not mesh.Color then
            return nil
        end
        
        -- Check if material is NOT Fabric OR color is NOT black (0,0,0)
        local isNotFabric = mesh.Material ~= Enum.Material.Fabric
        local color = mesh.Color
        local r, g, b = math.floor(color.R * 255), math.floor(color.G * 255), math.floor(color.B * 255)
        local isNotBlack = (r ~= 0 or g ~= 0 or b ~= 0)
        
        if isNotFabric or isNotBlack then
            local matName = tostring(mesh.Material):gsub("Enum.Material.", "")
            return string.format("%s (%d,%d,%d)", matName, r, g, b)
        end
        
        return nil
    end)
    
    if success then
        return result
    else
        -- Error occurred, return nil
        return nil
    end
end

-- Helper function to check mane texture
local function checkManeTexture(maneMesh)
    local success, result = pcall(function()
        if not maneMesh then return nil end
        
        -- Check for TextureID property (capital ID)
        if maneMesh.TextureID then
            local textureMatch = maneTextures[maneMesh.TextureID]
            if textureMatch then
                print("  Found mane texture match:", maneMesh.TextureID, "=", textureMatch)
                return textureMatch
            else
                print("  Mane TextureID not in list:", maneMesh.TextureID)
            end
        end
        
        -- Also check TextureId (lowercase 'd') just in case
        if maneMesh.TextureId then
            local textureMatch = maneTextures[maneMesh.TextureId]
            if textureMatch then
                print("  Found mane texture match:", maneMesh.TextureId, "=", textureMatch)
                return textureMatch
            else
                print("  Mane TextureId not in list:", maneMesh.TextureId)
            end
        end
        
        return nil
    end)
    
    if success then
        return result
    else
        print("  Error checking mane texture:", result)
        return nil
    end
end

-- Helper function to check body texture
local function checkBodyTexture(bodyPart)
    local success, result = pcall(function()
        if not bodyPart then return nil end
        
        -- Check for TextureID property (capital ID)
        if bodyPart.TextureID then
            local textureMatch = bodyTextures[bodyPart.TextureID]
            if textureMatch then
                print("  Found body texture match:", bodyPart.TextureID, "=", textureMatch)
                return textureMatch
            else
                print("  Body TextureID not in list:", bodyPart.TextureID)
            end
        end
        
        -- Also check TextureId (lowercase 'd') just in case
        if bodyPart.TextureId then
            local textureMatch = bodyTextures[bodyPart.TextureId]
            if textureMatch then
                print("  Found body texture match:", bodyPart.TextureId, "=", textureMatch)
                return textureMatch
            else
                print("  Body TextureId not in list:", bodyPart.TextureId)
            end
        end
        
        return nil
    end)
    
    if success then
        return result
    else
        print("  Error checking body texture:", result)
        return nil
    end
end

-- Find current island
local function findCurrentIsland()
    local char = player.Character
    if not char then return nil end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil end
    
    local islands = workspace:WaitForChild("Islands")
    local playerName = player.Name
    
    for _, island in pairs(islands:GetChildren()) do
        if island:IsA("Folder") or island:IsA("Model") then
            local playerCharInIsland = island:FindFirstChild(playerName)
            if playerCharInIsland and playerCharInIsland == char then
                return island
            end
            
            if char:IsDescendantOf(island) then
                return island
            end
        end
    end
    return nil
end

-- Scan function
local function scanIsland()
    print("=== SCAN STARTED ===")
    
    -- Clear previous results
    for _, child in pairs(scrollFrame:GetChildren()) do
        if child:IsA("Frame") or child:IsA("TextLabel") then
            child:Destroy()
        end
    end
    
    scanBtn.Text = "‚è≥ Scanning..."
    scanBtn.BackgroundColor3 = Color3.fromRGB(150, 150, 150)
    
    local island = findCurrentIsland()
    if not island then
        print("Not on an island")
        scanBtn.Text = "‚ùå Not on an island!"
        task.wait(2)
        scanBtn.Text = "üîç Scan Island"
        scanBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 250)
        return
    end
    
    print("Scanning island:", island.Name)
    local foundHorses = {}
    local modelsChecked = 0
    
    -- Scan all models in island
    for _, descendant in pairs(island:GetDescendants()) do
        if descendant:IsA("Model") and descendant.Name ~= player.Name then
            local hrp = descendant:FindFirstChild("HumanoidRootPart")
            local maneMesh = descendant:FindFirstChild("maneMesh")
            local bodyMesh = descendant:FindFirstChild("Body")
            local hornModel = descendant:FindFirstChild("hornModel")
            
            if hrp then
                modelsChecked = modelsChecked + 1
                
                -- Safely check each property
                local materialName = maneMesh and checkMaterial(maneMesh) or nil
                local maneTextureName = maneMesh and checkManeTexture(maneMesh) or nil
                local bodyTextureName = bodyMesh and checkBodyTexture(bodyMesh) or nil
                
                -- Debug output
                if materialName or maneTextureName or bodyTextureName or hornModel then
                    print("Found special horse:", descendant.Name)
                    if materialName then print("  Material:", materialName) end
                    if maneTextureName then print("  Mane:", maneTextureName) end
                    if bodyTextureName then print("  Body:", bodyTextureName) end
                    if hornModel then print("  Has horn!") end
                    
                    table.insert(foundHorses, {
                        model = descendant,
                        material = materialName,
                        maneTexture = maneTextureName,
                        bodyTexture = bodyTextureName,
                        hasHorn = hornModel ~= nil
                    })
                end
            end
        end
    end
    
    print("Models checked:", modelsChecked)
    print("Special horses found:", #foundHorses)
    print("Now displaying results...")
    
    -- Display results
    if #foundHorses == 0 then
        print("Creating 'no results' message")
        local noResults = Instance.new("TextLabel")
        noResults.Size = UDim2.new(1, -10, 0, 30)
        noResults.BackgroundTransparency = 1
        noResults.Text = "No special horses found üòî"
        noResults.TextColor3 = Color3.fromRGB(200, 200, 200)
        noResults.TextSize = 14
        noResults.Font = Enum.Font.Gotham
        noResults.Parent = scrollFrame
        print("No results message created")
    else
        print("Creating", #foundHorses, "result frames")
        for i, horse in ipairs(foundHorses) do
            print("Creating frame for horse", i)
            
            local resultFrame = Instance.new("Frame")
            resultFrame.Size = UDim2.new(1, -10, 0, 90)
            resultFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
            resultFrame.BorderSizePixel = 0
            resultFrame.Parent = scrollFrame
            
            local resultCorner = Instance.new("UICorner")
            resultCorner.CornerRadius = UDim.new(0, 6)
            resultCorner.Parent = resultFrame
            
            local infoLabel = Instance.new("TextLabel")
            infoLabel.Size = UDim2.new(1, -90, 1, -10)
            infoLabel.Position = UDim2.new(0, 10, 0, 5)
            infoLabel.BackgroundTransparency = 1
            infoLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
            infoLabel.TextSize = 13
            infoLabel.Font = Enum.Font.Gotham
            infoLabel.TextXAlignment = Enum.TextXAlignment.Left
            infoLabel.TextYAlignment = Enum.TextYAlignment.Top
            infoLabel.TextWrapped = true
            infoLabel.Parent = resultFrame
            
            local infoText = string.format("Horse #%d%s\n", i, horse.hasHorn and " ü¶Ñ" or "")
            if horse.material then
                infoText = infoText .. "Material: " .. horse.material .. "\n"
            end
            if horse.maneTexture then
                infoText = infoText .. "Mane: " .. horse.maneTexture .. "\n"
            end
            if horse.bodyTexture then
                infoText = infoText .. "Body: " .. horse.bodyTexture .. "\n"
            end
            if horse.hasHorn then
                infoText = infoText .. "ü¶Ñ Has Horn!"
            end
            infoLabel.Text = infoText
            
            local tpBtn = Instance.new("TextButton")
            tpBtn.Size = UDim2.new(0, 70, 0, 30)
            tpBtn.Position = UDim2.new(1, -80, 0.5, -15)
            tpBtn.BackgroundColor3 = Color3.fromRGB(100, 200, 100)
            tpBtn.Text = "TP"
            tpBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
            tpBtn.TextSize = 14
            tpBtn.Font = Enum.Font.GothamBold
            tpBtn.Parent = resultFrame
            
            local tpBtnCorner = Instance.new("UICorner")
            tpBtnCorner.CornerRadius = UDim.new(0, 6)
            tpBtnCorner.Parent = tpBtn
            
            tpBtn.MouseButton1Click:Connect(function()
                print("TP button clicked for horse", i)
                local char = player.Character
                if char and char:FindFirstChild("HumanoidRootPart") and horse.model:FindFirstChild("HumanoidRootPart") then
                    char.HumanoidRootPart.CFrame = horse.model.HumanoidRootPart.CFrame + Vector3.new(5, 0, 0)
                    print("Teleported!")
                end
            end)
            
            print("Frame", i, "created successfully")
        end
        print("All frames created!")
    end
    
    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y + 10)
    print("Canvas size updated")
    
    scanBtn.Text = "üîç Scan Island"
    scanBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 250)
    print("=== SCAN COMPLETE ===")
end

scanBtn.MouseButton1Click:Connect(scanIsland)

-- Auto-scan on load
task.wait(1)
scanIsland()
