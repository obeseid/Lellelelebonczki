-- eeeeeeeeeeeeeeeeeee

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ContentProvider = game:GetService("ContentProvider")

local player = Players.LocalPlayer
local terrain = workspace.Terrain
local renderingEnabled = true

-- Memory Cleanup Configuration
local CLEANUP_INTERVAL = 60 -- seconds (every minute)
local ENABLE_LOGGING = true
local AGGRESSIVE_MODE = true

-- Create GUI
local function createToggleButton()
	local screenGui = Instance.new("ScreenGui")
	screenGui.Name = "RenderingToggle"
	screenGui.ResetOnSpawn = false
	screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
	
	pcall(function()
		screenGui.Parent = game:GetService("CoreGui")
	end)
	
	if not screenGui.Parent then
		screenGui.Parent = player:WaitForChild("PlayerGui")
	end
	
	-- Main button frame
	local button = Instance.new("TextButton")
	button.Name = "RenderToggleButton"
	button.Size = UDim2.new(0, 180, 0, 50)
	button.Position = UDim2.new(1, -190, 0, 10)
	button.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
	button.BorderSizePixel = 2
	button.BorderColor3 = Color3.fromRGB(0, 255, 0)
	button.Font = Enum.Font.GothamBold
	button.TextSize = 16
	button.TextColor3 = Color3.fromRGB(255, 255, 255)
	button.Text = "ðŸŽ¥ Rendering: ON"
	button.AutoButtonColor = false
	button.Parent = screenGui
	
	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, 8)
	corner.Parent = button
	
	local shadow = Instance.new("Frame")
	shadow.Name = "Shadow"
	shadow.Size = UDim2.new(1, 4, 1, 4)
	shadow.Position = UDim2.new(0, -2, 0, 2)
	shadow.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
	shadow.BackgroundTransparency = 0.7
	shadow.ZIndex = button.ZIndex - 1
	shadow.BorderSizePixel = 0
	shadow.Parent = button
	
	local shadowCorner = Instance.new("UICorner")
	shadowCorner.CornerRadius = UDim.new(0, 8)
	shadowCorner.Parent = shadow
	
	local indicator = Instance.new("Frame")
	indicator.Name = "Indicator"
	indicator.Size = UDim2.new(0, 10, 0, 10)
	indicator.Position = UDim2.new(0, 10, 0.5, -5)
	indicator.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
	indicator.BorderSizePixel = 0
	indicator.Parent = button
	
	local indicatorCorner = Instance.new("UICorner")
	indicatorCorner.CornerRadius = UDim.new(1, 0)
	indicatorCorner.Parent = indicator
	
	-- Memory display label
	local memoryLabel = Instance.new("TextLabel")
	memoryLabel.Name = "MemoryLabel"
	memoryLabel.Size = UDim2.new(0, 180, 0, 25)
	memoryLabel.Position = UDim2.new(1, -190, 0, 70)
	memoryLabel.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
	memoryLabel.BorderSizePixel = 2
	memoryLabel.BorderColor3 = Color3.fromRGB(100, 100, 100)
	memoryLabel.Font = Enum.Font.Gotham
	memoryLabel.TextSize = 12
	memoryLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	memoryLabel.Text = "Memory: -- MB"
	memoryLabel.Parent = screenGui
	
	local memCorner = Instance.new("UICorner")
	memCorner.CornerRadius = UDim.new(0, 6)
	memCorner.Parent = memoryLabel
	
	return screenGui, button, indicator, memoryLabel
end

-- Toggle rendering function
local function toggleRendering()
	renderingEnabled = not renderingEnabled
	
	pcall(function()
		RunService:Set3dRenderingEnabled(renderingEnabled)
	end)
	
	return renderingEnabled
end

-- Update button appearance
local function updateButton(button, indicator, enabled)
	if enabled then
		button.Text = "ðŸŽ¥ Rendering: ON"
		button.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
		button.BorderColor3 = Color3.fromRGB(0, 255, 0)
		indicator.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
	else
		button.Text = "ðŸŽ¥ Rendering: OFF"
		button.BackgroundColor3 = Color3.fromRGB(60, 20, 20)
		button.BorderColor3 = Color3.fromRGB(255, 0, 0)
		indicator.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
	end
end

-- Add hover effect
local function addHoverEffect(button)
	button.MouseEnter:Connect(function()
		button.BackgroundTransparency = 0.2
	end)
	
	button.MouseLeave:Connect(function()
		button.BackgroundTransparency = 0
	end)
end

-- MEMORY CLEANUP FUNCTIONS

-- Aggressive memory cleanup function
local function aggressiveCleanup()
	local startTime = tick()
	local startMemory = gcinfo()
	
	if ENABLE_LOGGING then
		print("[Memory Cleanup] Starting aggressive cleanup...")
	end
	
	-- Multiple passes of garbage collection
	for i = 1, 5 do
		collectgarbage("count")
		task.wait(0.1)
	end
	
	-- Force clear all cached content (terrain data, textures, meshes)
	pcall(function()
		ContentProvider:ClearContent()
	end)
	
	task.wait(0.2)
	
	-- Additional terrain-specific cleanup
	if AGGRESSIVE_MODE then
		pcall(function()
			local pos = terrain.MaxExtents.Max
			terrain:ReadVoxels(Region3.new(pos, pos + Vector3.new(1,1,1)), 4)
		end)
		
		-- Clear any disconnected instances
		pcall(function()
			for _, obj in pairs(game:GetDescendants()) do
				if not obj.Parent and (obj:IsA("RemoteEvent") or obj:IsA("RemoteFunction") or obj:IsA("Part")) then
					pcall(function() obj:Destroy() end)
				end
			end
		end)
	end
	
	-- Final garbage collection passes
	for i = 1, 3 do
		collectgarbage("count")
		task.wait(0.1)
	end
	
	local endMemory = gcinfo()
	local memoryFreed = startMemory - endMemory
	local timeTaken = tick() - startTime
	
	if ENABLE_LOGGING then
		print(string.format(
			"[Memory Cleanup] âœ“ Freed %.2f MB in %.2f seconds",
			memoryFreed / 1024,
			timeTaken
		))
		print(string.format(
			"[Memory Cleanup] Current memory: %.2f MB",
			endMemory / 1024
		))
	end
	
	return endMemory / 1024
end

-- Monitor and track memory trends
local memoryHistory = {}
local function monitorMemory()
	local currentMemory = gcinfo() / 1024
	table.insert(memoryHistory, currentMemory)
	
	if #memoryHistory > 10 then
		table.remove(memoryHistory, 1)
	end
	
	if #memoryHistory >= 3 then
		local recent = memoryHistory[#memoryHistory]
		local older = memoryHistory[#memoryHistory - 2]
		local growth = recent - older
		
		if growth > 50 then
			warn(string.format(
				"[Memory Monitor] âš  Memory growing rapidly! +%.2f MB in last 2 minutes",
				growth
			))
		end
	end
	
	if ENABLE_LOGGING then
		print(string.format("[Memory Monitor] Current: %.2f MB", currentMemory))
	end
	
	-- Emergency cleanup at high memory
	if currentMemory > 1300 then
		warn("[Memory Monitor] ðŸš¨ HIGH MEMORY! Running emergency cleanup...")
		aggressiveCleanup()
	end
	
	return currentMemory
end

-- Initialize GUI
local screenGui, button, indicator, memoryLabel = createToggleButton()
addHoverEffect(button)

-- Button click event
button.MouseButton1Click:Connect(function()
	local enabled = toggleRendering()
	updateButton(button, indicator, enabled)
	
	local sound = Instance.new("Sound")
	sound.SoundId = "rbxasset://sounds/button.wav"
	sound.Volume = 0.5
	sound.Parent = screenGui
	sound:Play()
	game:GetService("Debris"):AddItem(sound, 1)
	
	local originalSize = button.Size
	button.Size = UDim2.new(0, 175, 0, 48)
	wait(0.1)
	button.Size = originalSize
end)

-- Update memory display continuously
task.spawn(function()
	while task.wait(2) do
		local currentMem = gcinfo() / 1024
		memoryLabel.Text = string.format("Memory: %.0f MB", currentMem)
		
		-- Color code memory label
		if currentMem < 1000 then
			memoryLabel.BorderColor3 = Color3.fromRGB(0, 255, 0)
		elseif currentMem < 1300 then
			memoryLabel.BorderColor3 = Color3.fromRGB(255, 165, 0)
		else
			memoryLabel.BorderColor3 = Color3.fromRGB(255, 0, 0)
		end
	end
end)

-- Initial cleanup and disable rendering
task.wait(5)
print("[Memory Manager] Initializing...")
aggressiveCleanup()

wait(0.5)
renderingEnabled = toggleRendering()
updateButton(button, indicator, renderingEnabled)

-- Run cleanup every minute
local cleanupCount = 0
task.spawn(function()
	while task.wait(CLEANUP_INTERVAL) do
		cleanupCount = cleanupCount + 1
		print(string.format("[Memory Manager] === Cleanup #%d ===", cleanupCount))
		aggressiveCleanup()
		task.wait(1)
		monitorMemory()
	end
end)

-- Teleport detection and cleanup
local lastPosition = nil
local TELEPORT_THRESHOLD = 500

task.spawn(function()
	while task.wait(2) do
		if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
			local currentPos = player.Character.HumanoidRootPart.Position
			
			if lastPosition then
				local distance = (currentPos - lastPosition).Magnitude
				
				if distance > TELEPORT_THRESHOLD then
					print("[Memory Manager] Large teleport detected, cleaning up...")
					task.wait(2)
					aggressiveCleanup()
				end
			end
			
			lastPosition = currentPos
		end
	end
end)

-- Cleanup when player is leaving
Players.PlayerRemoving:Connect(function(leavingPlayer)
	if leavingPlayer == player then
		collectgarbage("count")
	end
end)

print("âœ“ Rendering Toggle + Memory Manager loaded!")
print("âœ“ Rendering is now DISABLED")
print("âœ“ Memory cleanup running every " .. CLEANUP_INTERVAL .. " seconds")
print("âœ“ Teleport detection active")
