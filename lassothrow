-- Auto Lasso (robust) - place in StarterPlayerScripts
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local References = require(ReplicatedStorage:WaitForChild("References"))
local CharacterHandler = require(References.PlayerScripts.Priority:WaitForChild("CharacterHandler"))
local LassoModule = require(game:GetService("StarterPlayer")
    .StarterPlayerScripts
    .Classes
    .Equipment
    .Controllers
    .Lasso)

local COOLDOWN = 0.45         -- safe default; lower if you want to test faster
local RETRY_BACKOFF = 0.5     -- wait after an error
local lastThrow = 0

-- helper: check character & attachments the lasso expects exist
local function characterReady()
    local ch = CharacterHandler.object
    if not ch then return false end
    local inst = ch.instance
    if not inst then return false end

    local rightHand = inst:FindFirstChild("RightHand")
    if not rightHand then return false end
    if not rightHand:FindFirstChild("RightGripAttachment") then return false end

    return true
end

-- helper: check toolData is a lasso and is initialized
local function hasLassoTool()
    local ch = CharacterHandler.object
    if not ch then return nil end
    local toolData = ch.toolData
    if not toolData then return nil end
    if not toolData.lasso then return nil end
    -- (optionally) check for required fields the module expects
    if not toolData.instance then return nil end
    return toolData
end

-- Main loop using Heartbeat (runs on client)
RunService.Heartbeat:Connect(function(dt)
    local now = tick()

    -- cooldown check
    if now - lastThrow < COOLDOWN then
        return
    end

    -- must have character fully ready
    if not characterReady() then
        return
    end

    -- must have lasso-equipped tool data
    local toolData = hasLassoTool()
    if not toolData then
        return
    end

    -- prefer LassoModule.GetTarget (uses game's targeting)
    local ok, targetOrPos, posOrNil = pcall(function()
        return LassoModule.GetTarget(toolData)
    end)
    if not ok then
        -- If GetTarget itself errored, back off
        warn("AutoLasso: GetTarget error:", targetOrPos)
        task.wait(RETRY_BACKOFF)
        return
    end

    local target, pos = targetOrPos, posOrNil
    -- LassoModule.GetTarget may return (instance, position) or nil
    if not target or not pos then
        return
    end

    -- Call the real throw but protect with pcall
    local threwOk, threwErr = pcall(function()
        -- toolData:Throw(pos) is method-style; use colon form
        toolData:Throw(pos)
    end)

    if not threwOk then
        warn("AutoLasso: Throw() errored:", threwErr)
        -- if it's the 'nil instance' issue, give time for the lasso to initialize
        task.wait(RETRY_BACKOFF)
        return
    end

    -- record successful throw time
    lastThrow = tick()
end)
